From 00158492aa5a312a5f3caa55164b76dbfb789101 Mon Sep 17 00:00:00 2001
From: Heinrich Schuchardt <xypron.glpk@gmx.de>
Date: Fri, 22 Sep 2017 12:57:08 +0200
Subject: [PATCH 1/1] efi_loader: supply EFI SNP test

This patch provices an EFI application to check the correct function
of the Simple Network Protocol implementation.

It sends a DHCP request and analyzes the DHCP offer.

Signed-off-by: Heinrich Schuchardt <xypron.glpk@gmx.de>
---
 cmd/Kconfig                       | 12 ++++++++++++
 lib/efi_loader/Makefile           |  6 ++++++
 lib/efi_loader/efi_network_test.c | 23 +++++++++++++++++++++++
 3 files changed, 41 insertions(+)
 create mode 100644 lib/efi_loader/efi_network_test.c

diff --git a/cmd/Kconfig b/cmd/Kconfig
index 3ef9b16b08..57e2c6b49e 100644
--- a/cmd/Kconfig
+++ b/cmd/Kconfig
@@ -222,6 +222,18 @@ config CMD_BOOTEFI_HELLO
 	  for testing that EFI is working at a basic level, and for bringing
 	  up EFI support on a new architecture.
 
+config CMD_BOOTEFI_NETWORK_TEST_COMPILE
+	bool "Compile an EFI application for network testing"
+	depends on CMD_BOOTEFI && (ARM || X86)
+	default y
+	help
+	  This compiles an EFI application that tests the implemenation of the
+	  Simple Network Protocol (SNP) by sending a DHCP request and reading
+	  the DHCP offer.
+
+	  No additional space will be required in the resulting U-Boot binary
+	  when this option is enabled.
+
 source lib/efi_selftest/Kconfig
 
 config CMD_BOOTMENU
diff --git a/lib/efi_loader/Makefile b/lib/efi_loader/Makefile
index ddb978f650..1a3dd2b624 100644
--- a/lib/efi_loader/Makefile
+++ b/lib/efi_loader/Makefile
@@ -9,11 +9,17 @@
 
 CFLAGS_helloworld.o := $(CFLAGS_EFI)
 CFLAGS_REMOVE_helloworld.o := $(CFLAGS_NON_EFI)
+CFLAGS_efi_network_test.o := $(CFLAGS_EFI)
+CFLAGS_efi_network_test.o := $(CFLAGS_NON_EFI)
 
 ifneq ($(CONFIG_CMD_BOOTEFI_HELLO_COMPILE),)
 always += helloworld.efi
 endif
 
+ifneq ($(CONFIG_CMD_BOOTEFI_NETWORK_TEST_COMPILE),)
+always += efi_network_test.efi
+endif
+
 obj-$(CONFIG_CMD_BOOTEFI_HELLO) += helloworld_efi.o
 obj-y += efi_image_loader.o efi_boottime.o efi_runtime.o efi_console.o
 obj-y += efi_memory.o efi_device_path_to_text.o efi_device_path.o
diff --git a/lib/efi_loader/efi_network_test.c b/lib/efi_loader/efi_network_test.c
new file mode 100644
index 0000000000..77130a36dd
--- /dev/null
+++ b/lib/efi_loader/efi_network_test.c
@@ -0,0 +1,23 @@
+/*
+ * EFI hello world
+ *
+ * Copyright (c) 2016 Google, Inc
+ * Written by Simon Glass <sjg@chromium.org>
+ *
+ * SPDX-License-Identifier:     GPL-2.0+
+ */
+
+#include <common.h>
+#include <efi_api.h>
+
+efi_status_t EFIAPI efi_main(efi_handle_t handle,
+			     struct efi_system_table *systable)
+{
+	struct efi_simple_text_output_protocol *con_out = systable->con_out;
+	struct efi_boot_services *boottime = systable->boottime;
+
+	con_out->output_string(con_out, L"Hello, world!\n");
+	boottime->exit(handle, 0, 0, NULL);
+
+	return EFI_SUCCESS;
+}
-- 
2.14.1

